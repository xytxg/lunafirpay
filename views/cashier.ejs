<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>支付 - <%= order.display_name || order.name %></title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #006aff;
      --primary-hover: #0051cc;
      --text-primary: #1a1f36;
      --text-secondary: #697386;
      --border-color: #dde1e7;
      --bg-gray: #f5f7fb;
      --card-shadow: 0 18px 45px rgba(15, 23, 42, 0.08);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f5f5f7;
      min-height: 100vh;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 32px 16px;
      color: var(--text-primary);
    }

    .checkout-shell {
      width: 100%;
      max-width: 960px;
      border-radius: 12px;
      background: #ffffff;
      box-shadow: 0 12px 32px rgba(15, 23, 42, 0.08);
      overflow: hidden;
      animation: shellIn 200ms ease-out;
      border: 1px solid #e5e7eb;
    }

    @keyframes shellIn {
      0% { opacity: 0; transform: translateY(14px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    .checkout-container {
      display: flex;
      background: #ffffff;
    }
    
    /* 左侧订单信息 */
    .order-panel {
      flex: 0 0 420px;
      padding: 32px 32px 28px;
      border-right: 1px solid #edf0f4;
      background: #ffffff;
      display: flex;
      flex-direction: column;
    }
    
    .merchant-info {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 28px;
    }

    .merchant-logo {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      background: #f5f5f7;
    }

    .merchant-name {
      font-size: 15px;
      font-weight: 600;
    }
    
    .order-amount {
      margin-bottom: 28px;
    }

    .amount-label {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 10px;
    }

    .amount-value {
      font-size: 36px;
      font-weight: 600;
      letter-spacing: -0.03em;
      color: var(--text-primary);
    }

    .amount-value .currency {
      font-size: 24px;
      font-weight: 500;
      margin-right: 4px;
    }
    
    .order-details {
      flex: 1;
    }

    .detail-item {
      padding: 12px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .detail-item:last-child {
      border-bottom: none;
    }
    
    .detail-label {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .detail-value {
      font-size: 14px;
      color: var(--text-primary);
      text-align: right;
      max-width: 180px;
      word-break: break-all;
    }
    
    .powered-by {
      margin-top: auto;
      padding-top: 24px;
      font-size: 11px;
      color: var(--text-secondary);
    }
    
    /* 右侧支付方式 */
    .payment-panel {
      flex: 1;
      padding: 32px 32px 28px;
      background: #f7f7f9;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .panel-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 18px;
    }

    .section {
      background: #ffffff;
      border-radius: 10px;
      border: 1px solid #eaedf3;
      padding: 14px 16px;
    }

    .section-title {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 10px;
    }
    
    .payment-methods {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .payment-method {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 10px;
      border-radius: 8px;
      cursor: pointer;
      background: #ffffff;
      border: 1px solid transparent;
      transition: border-color 0.16s ease, background 0.16s ease;
    }

    .payment-method:hover {
      border-color: #d6dae3;
      background: #f8fafc;
    }

    .payment-method.active {
      border-color: var(--primary-color);
      background: #f5f8ff;
    }

    .payment-method.active .method-radio::after {
      transform: scale(1);
      opacity: 1;
    }

    .method-radio {
      width: 16px;
      height: 16px;
      border: 1px solid #c5cad6;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      position: relative;
    }

    .method-radio::after {
      content: '';
      position: absolute;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--primary-color);
      transform: scale(0.2);
      opacity: 0;
      transition: transform 0.16s ease, opacity 0.16s ease;
    }

    .method-icon {
      width: 32px;
      height: 32px;
      border-radius: 4px;
      object-fit: contain;
      background: #ffffff;
    }

    .method-info {
      flex: 1;
    }

    .method-name {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .method-desc {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .pay-button {
      width: 100%;
      height: 44px;
      background: var(--primary-color);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 6px 16px rgba(0, 106, 255, 0.35);
      transition: background-color 0.12s ease, box-shadow 0.12s ease, transform 0.12s ease;
    }

    .pay-button:hover {
      background: var(--primary-hover);
      transform: translateY(-0.5px);
      box-shadow: 0 8px 18px rgba(0, 106, 255, 0.45);
    }

    .pay-button:active {
      transform: translateY(0);
      box-shadow: 0 4px 12px rgba(0, 106, 255, 0.35);
    }

    .pay-button:disabled {
      background: #c7d2e6;
      cursor: not-allowed;
      box-shadow: none;
    }

    .pay-button .spinner {
      width: 18px;
      height: 18px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .secure-notice {
      margin-top: 8px;
      text-align: center;
      font-size: 11px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .secure-notice svg {
      width: 14px;
      height: 14px;
    }
    
    .no-methods {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }
    
    .no-methods svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* 二维码区域 */
    .qrcode-panel {
      margin-top: 8px;
      text-align: center;
      display: none; /* 默认隐藏，点击支付后显示 */
    }

    .qrcode-wrapper {
      background: #ffffff;
      border-radius: 10px;
      border: 1px solid #eaedf3;
      padding: 18px;
      margin-bottom: 12px;
    }

    .qrcode-box {
      display: inline-block;
      background: #fff;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #eaedf3;
    }

    .qrcode-box img {
      width: 180px;
      height: 180px;
      display: block;
    }

    .qrcode-tip {
      margin-top: 12px;
      font-size: 13px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .qrcode-tip svg {
      width: 18px;
      height: 18px;
      color: #10b981;
    }

    /* 加密货币支付样式 */
    .crypto-wrapper {
      background: #ffffff;
      border-radius: 10px;
      border: 1px solid #eaedf3;
      padding: 20px;
      text-align: center;
    }

    .crypto-header {
      margin-bottom: 16px;
    }

    .crypto-currency {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .crypto-currency > span:first-child {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .crypto-badge {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: #fff;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 500;
    }

    .crypto-amount {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.02em;
    }

    .crypto-amount-cny {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .crypto-address-section {
      margin-top: 16px;
      text-align: left;
    }

    .crypto-address-label {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .crypto-address-box {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .crypto-address {
      flex: 1;
      font-family: 'SF Mono', Monaco, Consolas, monospace;
      font-size: 12px;
      color: #374151;
      word-break: break-all;
      line-height: 1.5;
    }

    .crypto-copy-btn {
      background: var(--primary-color);
      color: #fff;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      white-space: nowrap;
      transition: background 0.15s;
    }

    .crypto-copy-btn:hover {
      background: var(--primary-hover);
    }

    .crypto-copy-btn.copied {
      background: #10b981;
    }

    .crypto-tips {
      margin-top: 16px;
      padding: 14px;
      background: #fef3c7;
      border-radius: 8px;
      text-align: left;
    }

    .crypto-tips-title {
      font-size: 13px;
      font-weight: 600;
      color: #92400e;
      margin-bottom: 8px;
    }

    .crypto-tips ul {
      font-size: 12px;
    }

    /* 支付宝H5唤起APP样式 */
    .alipay-h5-wrapper {
      background: linear-gradient(135deg, #1677ff 0%, #0958d9 100%);
      border-radius: 10px;
      padding: 24px 20px;
      text-align: center;
    }

    .alipay-h5-logo {
      margin-bottom: 16px;
    }

    .alipay-h5-logo img {
      width: 48px;
      height: 48px;
      vertical-align: middle;
    }

    .alipay-h5-logo span {
      color: #fff;
      font-size: 20px;
      font-weight: 500;
      margin-left: 10px;
      vertical-align: middle;
    }

    .alipay-h5-amount {
      font-size: 36px;
      color: #fff;
      font-weight: 600;
      margin-bottom: 20px;
    }

    .alipay-h5-btn {
      display: block;
      width: 100%;
      padding: 14px;
      background: #fff;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      color: #1677ff;
      cursor: pointer;
      text-decoration: none;
      text-align: center;
      margin-bottom: 10px;
      transition: all 0.3s;
    }

    .alipay-h5-btn:hover {
      background: #f0f5ff;
    }

    .alipay-h5-btn-secondary {
      background: rgba(255,255,255,0.2);
      color: #fff;
    }

    .alipay-h5-btn-secondary:hover {
      background: rgba(255,255,255,0.3);
      color: #78350f;
      padding-left: 16px;
      margin: 0;
      line-height: 1.8;
    }

    .qrcode-status {
      margin-top: 12px;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .qrcode-status.waiting {
      background: #fef3c7;
      color: #b45309;
    }

    .qrcode-status.success {
      background: #d1fae5;
      color: #047857;
    }

    .qrcode-status .status-spinner {
      width: 14px;
      height: 14px;
      border: 2px solid #b45309;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .qrcode-countdown {
      margin-top: 8px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .qrcode-back-btn {
      margin-top: 12px;
      padding: 10px 20px;
      background: #f3f4f6;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      color: #374151;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.15s;
    }

    .qrcode-back-btn:hover {
      background: #e5e7eb;
    }
    
    /* 响应式 */
    @media (max-width: 768px) {
      body {
        padding: 16px 0;
        background: #f3f5fa;
      }

      .checkout-shell {
        border-radius: 0;
        box-shadow: none;
      }

      .checkout-container {
        flex-direction: column;
      }

      .order-panel {
        flex: none;
        padding: 20px 16px 16px;
        border-right: none;
        border-bottom: 1px solid #edf0f4;
      }

      .amount-value {
        font-size: 30px;
      }

      .payment-panel {
        padding: 20px 16px 16px;
      }
    }
  </style>
</head>
<body>
  <div class="checkout-shell">
    <div class="checkout-container">
    <!-- 左侧订单信息 -->
    <div class="order-panel">
      <div class="merchant-info">
        <div class="merchant-name"><%= sitename || '在线支付' %></div>
      </div>
      
      <div class="order-amount">
        <div class="amount-label">向 <%= sitename || '商户' %> 支付</div>
        <div class="amount-value">
          <% if (typeof isCrypto !== 'undefined' && isCrypto) { %>
            <span class="currency">¥</span><%= parseFloat(order.money).toFixed(2) %>
          <% } else { %>
            <span class="currency">¥</span><%= parseFloat(order.money).toFixed(2) %>
          <% } %>
        </div>
      </div>
      
      <div class="order-details">
        <div class="detail-item">
          <span class="detail-label">商品名称</span>
          <span class="detail-value"><%= order.display_name || order.name %></span>
        </div>
        <div class="detail-item">
          <span class="detail-label">订单号</span>
          <span class="detail-value"><%= order.trade_no %></span>
        </div>
        <div class="detail-item">
          <span class="detail-label">商户订单号</span>
          <span class="detail-value"><%= order.out_trade_no %></span>
        </div>
        <div class="detail-item">
          <span class="detail-label">创建时间</span>
          <span class="detail-value"><%= new Date(order.created_at).toLocaleString('zh-CN') %></span>
        </div>
      </div>
      
      <div class="powered-by">
        Powered by LunaFir
      </div>
    </div>
    
    <!-- 右侧支付方式 + 二维码 -->
    <div class="payment-panel">
      <h2 class="panel-title">结算</h2>
      
      <% if (payTypes.length === 0) { %>
        <div class="no-methods">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          <p>暂无可用支付方式</p>
          <p style="font-size: 12px; margin-top: 8px;">请联系商户配置支付通道</p>
        </div>
      <% } else { %>
        <!-- 支付方式卡片 -->
        <div class="section" id="payMethodSection">
          <div class="section-title">支付方式</div>
          <div class="payment-methods">
          <% payTypes.forEach(function(pt, index) { %>
            <div class="payment-method <%= pt.type_code === order.pay_type ? 'active' : '' %>" 
                 data-type="<%= pt.type_code %>" 
                 data-group="<%= pt.group_id || '' %>"
                 data-crypto="<%= pt.is_crypto ? '1' : '0' %>">
              <div class="method-radio"></div>
              <% if (pt.is_crypto) { %>
                <%
                  // 固定图标映射
                  var iconMap = {
                    'tron-USDT': '/assets/crypto/tron-usdt.jpg',
                    'tron-USDC': '/assets/crypto/tron-usdc.jpg',
                    'tron-TRX': '/assets/crypto/tron-trx.jpg',
                    'ethereum-USDT': '/assets/crypto/ethereum-usdt.jpg',
                    'ethereum-USDC': '/assets/crypto/ethereum-usdc.jpg',
                    'polygon-USDT': '/assets/crypto/pol-usdt.jpg',
                    'polygon-USDC': '/assets/crypto/pol-usdc.jpg',
                    'arbitrum-USDT': '/assets/crypto/arbitrum-usdt.jpg',
                    'arbitrum-USDC': '/assets/crypto/arbitrum-usdc.jpg'
                  };
                  var iconKey = (pt.network || 'tron') + '-' + (pt.currency || 'USDT');
                  var iconSrc = iconMap[iconKey] || '/assets/crypto/tron-usdt.jpg';
                %>
                <img class="method-icon" 
                     src="<%= iconSrc %>" 
                     alt="<%= pt.type_name %>"
                     onerror="this.src='/assets/crypto/tron-usdt.jpg'"
                     style="border-radius: 50%;">
              <% } else { %>
                <img class="method-icon" 
                     src="/assets/icon/<%= pt.type_code %>.ico" 
                     alt="<%= pt.type_name %>"
                     onerror="this.src='/assets/img/<%= pt.type_code %>.png'">
              <% } %>
              <div class="method-info">
                <div class="method-name"><%= pt.type_name %></div>
                <div class="method-desc">
                  <% if (pt.is_crypto) { %>
                    加密货币支付 · <%= pt.network || '' %>
                  <% } else if (pt.type_code === 'alipay') { %>
                    支持支付宝 APP 和扫码支付
                  <% } else if (pt.type_code === 'wxpay') { %>
                    支持微信 APP 和扫码支付
                  <% } else if (pt.type_code === 'qqpay') { %>
                    支持 QQ 钱包支付
                  <% } else if (pt.type_code === 'bank') { %>
                    支持各大银行网银支付
                  <% } else { %>
                    安全快捷支付
                  <% } %>
                </div>
              </div>
            </div>
          <% }); %>
          </div>
        </div>
        
        <!-- 底部按钮区域 -->
        <button class="pay-button" id="payBtn">
          <span>支付</span>
        </button>
        
        <div class="secure-notice">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
          </svg>
          <span>此支付页面受 TLS 加密保护</span>
        </div>

        <!-- 二维码显示区域：与支付方式同页显示 -->
        <div class="qrcode-panel" id="qrcodePanel">
          <!-- 普通支付二维码 -->
          <div class="qrcode-wrapper" id="normalQrcodeWrapper">
            <div class="qrcode-box">
              <img id="qrcodeImg" src="" alt="支付二维码">
            </div>
            <div class="qrcode-tip">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/>
                <path d="M9 12l2 2 4-4"/>
              </svg>
              <span id="qrcodeTipText">请使用对应APP扫描二维码完成支付</span>
            </div>
          </div>
          
          <!-- 支付宝H5唤起APP -->
          <div class="alipay-h5-wrapper" id="alipayH5Wrapper" style="display:none;">
            <div class="alipay-h5-logo">
              <img src="/assets/img/alipay.png" alt="支付宝" onerror="this.style.display='none'">
              <span>支付宝支付</span>
            </div>
            <div class="alipay-h5-amount" id="alipayH5Amount">¥0.00</div>
            <a href="javascript:;" id="alipayH5OpenBtn" class="alipay-h5-btn">跳转到支付宝支付</a>
            <a href="javascript:checkAlipayH5Result()" class="alipay-h5-btn alipay-h5-btn-secondary">检测支付状态</a>
          </div>
          
          <!-- 加密货币支付信息 -->
          <div class="crypto-wrapper" id="cryptoWrapper" style="display:none;">
            <div class="crypto-header">
              <div class="crypto-currency">
                <span id="cryptoCurrency">USDT</span>
                <span class="crypto-badge" id="cryptoNetwork">TRC20</span>
              </div>
              <div class="crypto-amount">
                <span id="cryptoAmount">0.00</span> <span id="cryptoCurrencyUnit">USDT</span>
              </div>
              <div class="crypto-amount-cny">≈ ¥<span id="cryptoAmountCny">0.00</span></div>
            </div>
            <div class="qrcode-box">
              <img id="cryptoQrcodeImg" src="" alt="钱包地址二维码">
            </div>
            <div class="crypto-address-section">
              <div class="crypto-address-label">收款地址</div>
              <div class="crypto-address-box">
                <span class="crypto-address" id="cryptoAddress"></span>
                <button class="crypto-copy-btn" onclick="copyCryptoAddress()">复制</button>
              </div>
            </div>
            <div class="crypto-tips">
              <div class="crypto-tips-title">⚠️ 重要提示</div>
              <ul>
                <li>请务必转账准确金额，金额必须完全一致</li>
                <li>仅支持指定网络转账，其他网络转账将无法到账</li>
                <li>转账完成后请等待区块链确认</li>
              </ul>
            </div>
          </div>
          
          <div class="qrcode-status waiting" id="qrcodeStatus">
            <span class="status-spinner"></span>
            <span>等待支付中...</span>
          </div>
          <div class="qrcode-countdown" id="qrcodeCountdown">
            订单过期时间: <span id="expireTime">--:--:--</span>
          </div>
          <button class="qrcode-back-btn" id="qrcodeBackBtn">返回选择其他支付方式</button>
        </div>
      <% } %>
    </div>
    </div>
  </div>

  <script>
    (function() {
      var selectedType = '<%= order.pay_type || "" %>';
      var selectedGroupId = '<%= selectedGroupId %>';
      var tradeNo = '<%= order.trade_no %>';
      
      // 已存在的加密货币订单（用于页面刷新后恢复状态）
      var existingCryptoOrder = <%- typeof existingCryptoOrder !== 'undefined' && existingCryptoOrder ? JSON.stringify(existingCryptoOrder) : 'null' %>;
      
      // 已锁定的支付信息（订单已选择通道，不可更改）
      var lockedPayment = <%- typeof lockedPayment !== 'undefined' && lockedPayment ? JSON.stringify(lockedPayment) : 'null' %>;
      
      // 选择支付方式（仅在未锁定时可用）
      document.querySelectorAll('.payment-method').forEach(function(item) {
        item.addEventListener('click', function() {
          // 如果已锁定，不允许切换
          if (lockedPayment) {
            return;
          }
          document.querySelectorAll('.payment-method').forEach(function(i) {
            i.classList.remove('active');
          });
          this.classList.add('active');
          selectedType = this.dataset.type;
          selectedGroupId = this.dataset.group;
          
          // 异步更新订单支付方式
          fetch('/api/pay/select_channel', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              trade_no: tradeNo, 
              pay_type: selectedType, 
              group_id: selectedGroupId 
            })
          }).catch(function(e) {
            console.warn('更新支付方式失败:', e);
          });
        });
      });
      
      // 二维码相关元素
      var qrcodePanel = document.getElementById('qrcodePanel');
      var qrcodeImg = document.getElementById('qrcodeImg');
      var normalQrcodeWrapper = document.getElementById('normalQrcodeWrapper');
      var cryptoWrapper = document.getElementById('cryptoWrapper');
      var qrcodeStatus = document.getElementById('qrcodeStatus');
      var qrcodeCountdown = document.getElementById('qrcodeCountdown');
      var expireTimeEl = document.getElementById('expireTime');
      var qrcodeBackBtn = document.getElementById('qrcodeBackBtn');
      var payMethodSection = document.getElementById('payMethodSection');
      var secureNotice = document.querySelector('.secure-notice');
      var checkInterval = null;
      var countdownInterval = null;
      var expireTimestamp = null;  // 过期时间戳
      var returnUrl = '<%= order.return_url || "" %>';
      var currentCryptoTradeNo = null;  // 当前加密货币订单号
      var alipayH5Wrapper = document.getElementById('alipayH5Wrapper');
      var alipayH5SchemeUrl = null;  // 支付宝H5协议URL

      // 显示支付宝H5唤起APP面板
      function showAlipayH5(schemeUrl, money) {
        normalQrcodeWrapper.style.display = 'none';
        cryptoWrapper.style.display = 'none';
        alipayH5Wrapper.style.display = 'block';
        
        alipayH5SchemeUrl = schemeUrl;
        document.getElementById('alipayH5Amount').textContent = '¥' + parseFloat(money).toFixed(2);
        document.getElementById('alipayH5OpenBtn').href = schemeUrl;
        
        if (payMethodSection) payMethodSection.style.display = 'none';
        if (secureNotice) secureNotice.style.display = 'none';
        if (payBtn) payBtn.style.display = 'none';
        qrcodePanel.style.display = 'block';
        qrcodeStatus.className = 'qrcode-status waiting';
        qrcodeStatus.innerHTML = '<span class="status-spinner"></span><span>等待支付中...</span>';
        
        // 自动跳转（非Edge浏览器）
        if (!schemeUrl.startsWith('http://') && !schemeUrl.startsWith('https://') && navigator.userAgent.indexOf('EdgA/') === -1) {
          window.location.href = schemeUrl;
        }
        
        // 开始轮询检测
        startPolling();
      }
      
      // 检测支付宝H5支付结果
      window.checkAlipayH5Result = function() {
        fetch('/api/pay/check_status?trade_no=' + tradeNo)
          .then(function(response) { return response.json(); })
          .then(function(data) {
            if (data.code === 0 && data.status === 1) {
              qrcodeStatus.className = 'qrcode-status success';
              qrcodeStatus.innerHTML = '<span>支付成功，正在跳转中...</span>';
              setTimeout(function() {
                window.location.href = returnUrl || '/api/pay/success?trade_no=' + tradeNo;
              }, 1000);
            } else {
              alert('您还未完成付款，请继续付款');
            }
          })
          .catch(function() {
            alert('服务器错误');
          });
      };

      // 显示普通支付二维码
      function showQrcode(qrcodeUrl, payTypeName, expireTime, isLocked) {
        normalQrcodeWrapper.style.display = 'block';
        cryptoWrapper.style.display = 'none';
        qrcodeImg.src = 'https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=' + encodeURIComponent(qrcodeUrl);
        var tipTextEl = document.getElementById('qrcodeTipText');
        if (tipTextEl && payTypeName) {
          tipTextEl.textContent = '请使用 ' + payTypeName + ' 扫描二维码完成支付';
        }
        payMethodSection.style.display = 'none';
        payBtn.style.display = 'none';
        secureNotice.style.display = 'none';
        // 设置过期时间
        if (expireTime) {
          expireTimestamp = new Date(expireTime).getTime();
        } else {
          expireTimestamp = Date.now() + 300 * 1000;  // 默认5分钟
        }
        updateExpireTimeDisplay();
        qrcodeStatus.className = 'qrcode-status waiting';
        qrcodeStatus.innerHTML = '<span class="status-spinner"></span><span>等待扫码支付...</span>';
        qrcodeCountdown.style.display = 'block';
        qrcodePanel.style.display = 'block';
        // 如果已锁定，隐藏返回按钮
        if (isLocked || lockedPayment) {
          qrcodeBackBtn.style.display = 'none';
        } else {
          qrcodeBackBtn.style.display = 'block';
        }
        startPolling();
        startCountdown();
      }

      // 显示加密货币支付二维码
      function showCryptoQrcode(cryptoData, isLocked) {
        normalQrcodeWrapper.style.display = 'none';
        cryptoWrapper.style.display = 'block';
        currentCryptoTradeNo = cryptoData.trade_no;
        
        // 填充加密货币信息
        document.getElementById('cryptoCurrency').textContent = cryptoData.currency;
        document.getElementById('cryptoNetwork').textContent = cryptoData.token_type + ' · ' + cryptoData.network_name;
        document.getElementById('cryptoAmount').textContent = cryptoData.amount;
        document.getElementById('cryptoCurrencyUnit').textContent = cryptoData.currency;
        document.getElementById('cryptoAmountCny').textContent = cryptoData.amount_cny;
        document.getElementById('cryptoAddress').textContent = cryptoData.wallet_address;
        document.getElementById('cryptoQrcodeImg').src = 'https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=' + encodeURIComponent(cryptoData.wallet_address);
        
        payMethodSection.style.display = 'none';
        payBtn.style.display = 'none';
        secureNotice.style.display = 'none';
        // 设置过期时间（+8时区）
        if (cryptoData.expire_time) {
          expireTimestamp = new Date(cryptoData.expire_time).getTime();
        } else {
          expireTimestamp = Date.now() + 300 * 1000;  // 默认5分钟
        }
        updateExpireTimeDisplay();
        qrcodeStatus.className = 'qrcode-status waiting';
        qrcodeStatus.innerHTML = '<span class="status-spinner"></span><span>等待转账中，请转账准确金额...</span>';
        qrcodeCountdown.style.display = 'block';
        qrcodePanel.style.display = 'block';
        // 如果已锁定，隐藏返回按钮
        if (isLocked || lockedPayment) {
          qrcodeBackBtn.style.display = 'none';
        } else {
          qrcodeBackBtn.style.display = 'block';
        }
        startCryptoPolling();
        startCountdown();
      }

      // 隐藏二维码，返回选择
      function hideQrcode() {
        clearInterval(checkInterval);
        clearInterval(countdownInterval);
        qrcodePanel.style.display = 'none';
        normalQrcodeWrapper.style.display = 'block';
        cryptoWrapper.style.display = 'none';
        currentCryptoTradeNo = null;
        payMethodSection.style.display = 'block';
        payBtn.style.display = 'flex';
        payBtn.disabled = false;
        payBtn.innerHTML = '<span>支付</span>';
        secureNotice.style.display = 'flex';
      }

      // 轮询检查普通订单支付状态
      function startPolling() {
        clearInterval(checkInterval);
        checkInterval = setInterval(function() {
          fetch('/api/pay/check_status?trade_no=' + tradeNo)
            .then(function(res) { return res.json(); })
            .then(function(data) {
              if (data.code === 0 && data.paid) {
                onPaymentSuccess();
              }
            })
            .catch(function(err) {
              console.error('检查状态失败:', err);
            });
        }, 2000);
      }

      // 轮询检查加密货币订单支付状态
      function startCryptoPolling() {
        clearInterval(checkInterval);
        if (!currentCryptoTradeNo) return;
        checkInterval = setInterval(function() {
          fetch('/api/crypto/check/' + currentCryptoTradeNo)
            .then(function(res) { return res.json(); })
            .then(function(data) {
              if (data.code === 0 && data.paid) {
                onPaymentSuccess();
              }
            })
            .catch(function(err) {
              console.error('检查状态失败:', err);
            });
        }, 3000);
      }

      // 支付成功处理
      function onPaymentSuccess() {
        clearInterval(checkInterval);
        clearInterval(countdownInterval);
        qrcodeStatus.className = 'qrcode-status success';
        qrcodeStatus.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg><span>支付成功！正在跳转...</span>';
        qrcodeCountdown.style.display = 'none';
        qrcodeBackBtn.style.display = 'none';
        setTimeout(function() {
          if (returnUrl) {
            window.location.href = returnUrl;
          } else {
            window.location.href = '/api/pay/success?trade_no=' + tradeNo;
          }
        }, 1500);
      }

      // 格式化过期时间为北京时间 (UTC+8)
      function formatExpireTime(timestamp) {
        var date = new Date(timestamp);
        // 转换为北京时间 (+8时区)
        var utc = date.getTime() + date.getTimezoneOffset() * 60000;
        var beijingTime = new Date(utc + 8 * 3600000);
        var hours = String(beijingTime.getHours()).padStart(2, '0');
        var minutes = String(beijingTime.getMinutes()).padStart(2, '0');
        var seconds = String(beijingTime.getSeconds()).padStart(2, '0');
        return hours + ':' + minutes + ':' + seconds;
      }

      // 更新过期时间显示
      function updateExpireTimeDisplay() {
        if (expireTimestamp) {
          expireTimeEl.textContent = formatExpireTime(expireTimestamp);
        }
      }

      // 倒计时（检查是否过期）
      function startCountdown() {
        clearInterval(countdownInterval);
        countdownInterval = setInterval(function() {
          var now = Date.now();
          if (now >= expireTimestamp) {
            clearInterval(countdownInterval);
            clearInterval(checkInterval);
            qrcodeStatus.className = 'qrcode-status';
            qrcodeStatus.style.background = '#fee2e2';
            qrcodeStatus.style.color = '#b91c1c';
            qrcodeStatus.innerHTML = '<span>订单已超时关闭</span>';
            qrcodeCountdown.style.display = 'none';
          }
        }, 1000);
      }

      // 返回按钮
      if (qrcodeBackBtn) {
        qrcodeBackBtn.addEventListener('click', hideQrcode);
      }

      // 支付按钮
      var payBtn = document.getElementById('payBtn');
      if (payBtn) {
        payBtn.addEventListener('click', async function() {
          if (!selectedType) {
            alert('请选择支付方式');
            return;
          }
          
          this.disabled = true;
          this.innerHTML = '<div class="spinner"></div><span>处理中...</span>';
          
          try {
            var res = await fetch('/api/pay/dopay', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ 
                trade_no: tradeNo, 
                pay_type: selectedType, 
                group_id: selectedGroupId 
              })
            });
            var data = await res.json();
            
            if (data.code === 0) {
              if (data.html) {
                // HTML表单自动提交（如支付宝网页支付）
                document.open();
                document.write(data.html);
                document.close();
              } else if (data.type === 'crypto' && data.crypto) {
                // 加密货币支付 - 在当前页面显示二维码
                showCryptoQrcode(data.crypto);
              } else if (data.scheme) {
                // APP跳转协议（如支付宝/微信APP唤起）
                window.location.href = data.scheme;
              } else if (data.alipay_h5) {
                // 支付宝H5唤起APP - 在当前页面显示
                showAlipayH5(data.alipay_h5.code_url, data.alipay_h5.money || '<%= order.money %>');
              } else if (data.qrcode) {
                // 普通支付二维码 - 在当前页面显示（优先于跳转）
                var activeMethod = document.querySelector('.payment-method.active');
                var payTypeName = activeMethod ? activeMethod.querySelector('.method-name').textContent : '';
                showQrcode(data.qrcode, payTypeName);
              } else if (data.pay_url) {
                // 普通支付 - 跳转到支付页面
                window.location.href = data.pay_url;
              }
            } else {
              alert(data.msg || '支付失败，请稍后重试');
              this.disabled = false;
              this.innerHTML = '<span>支付</span>';
            }
          } catch (e) {
            alert('网络错误，请检查网络后重试');
            this.disabled = false;
            this.innerHTML = '<span>支付</span>';
          }
        });
      }

      // 复制加密货币地址
      window.copyCryptoAddress = function() {
        var address = document.getElementById('cryptoAddress').textContent;
        navigator.clipboard.writeText(address).then(function() {
          var btn = document.querySelector('.crypto-copy-btn');
          btn.textContent = '已复制';
          btn.classList.add('copied');
          setTimeout(function() {
            btn.textContent = '复制';
            btn.classList.remove('copied');
          }, 2000);
        }).catch(function() {
          // fallback
          var textarea = document.createElement('textarea');
          textarea.value = address;
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
          var btn = document.querySelector('.crypto-copy-btn');
          btn.textContent = '已复制';
          btn.classList.add('copied');
          setTimeout(function() {
            btn.textContent = '复制';
            btn.classList.remove('copied');
          }, 2000);
        });
      };

      // 页面加载时检查是否有已存在的加密货币订单，自动恢复显示二维码
      if (existingCryptoOrder) {
        showCryptoQrcode(existingCryptoOrder, true);
      }
      // 如果订单已锁定通道，自动触发支付
      else if (lockedPayment) {
        // 禁用支付方式选择
        document.querySelectorAll('.payment-method').forEach(function(item) {
          if (item.dataset.type !== lockedPayment.pay_type) {
            item.style.opacity = '0.5';
            item.style.pointerEvents = 'none';
          }
        });
        
        // 自动点击支付按钮
        setTimeout(function() {
          if (payBtn) {
            payBtn.click();
          }
        }, 300);
      }
    })();
  </script>
</body>
</html>
